<!DOCTYPE html>
<html>
<head>
    <title>Game Chat Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; background: #f9f9f9; }
        .log { background: #f0f0f0; padding: 10px; height: 300px; overflow-y: auto; margin: 10px 0; border: 1px solid #ccc; }
        button { margin: 5px; padding: 8px 12px; }
        input { margin: 5px; padding: 5px; width: 200px; }
        .status { font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Game Chat Debug - Exactly Like Your Game</h1>
    
    <div class="debug-section">
        <h3>Step 1: Connect to WebSocket</h3>
        <button onclick="testWebSocketConnection()">Connect WebSocket</button>
        <div id="wsStatus" class="status">Not connected</div>
    </div>
    
    <div class="debug-section">
        <h3>Step 2: CREATE New Room (Don't Join 8LWJZZ - It's Gone!)</h3>
        <input type="text" id="playerName" value="TestPlayer" placeholder="Player Name">
        <button onclick="createRoom()">Create NEW Room</button>
        <button onclick="joinRoom()">Try Join 8LWJZZ (Will Fail)</button>
        <div id="roomStatus" class="status">Not in room</div>
    </div>
    
    <div class="debug-section">
        <h3>Step 3: Send Chat Messages</h3>
        <input type="text" id="chatMessage" placeholder="Type your message...">
        <button onclick="sendChatMessage()">Send Chat</button>
        <div id="chatStatus" class="status">Ready to send</div>
    </div>
    
    <div class="debug-section">
        <h3>Debug Log</h3>
        <div id="debugLog" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <script>
        let ws = null;
        let connected = false;
        let roomJoined = false;
        
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            const entry = `[${time}] ${message}`;
            logDiv.innerHTML += `<div>${entry}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(entry);
        }
        
        function testWebSocketConnection() {
            if (ws) {
                ws.close();
            }
            
            log('🔌 Connecting to WebSocket at ws://localhost:8080...');
            document.getElementById('wsStatus').textContent = 'Connecting...';
            
            ws = new WebSocket('ws://localhost:8080');
            
            ws.onopen = function() {
                log('✅ WebSocket connected successfully');
                document.getElementById('wsStatus').textContent = 'Connected';
                connected = true;
            };
            
            ws.onmessage = function(event) {
                log(`📨 Received from server: ${event.data}`);
                
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'room_created') {
                        roomJoined = true;
                        log(`🏠 Successfully created room: ${data.data.roomCode}`);
                        document.getElementById('roomStatus').textContent = `Created room: ${data.data.roomCode}`;
                    } else if (data.type === 'room_joined') {
                        roomJoined = true;
                        log(`🏠 Successfully joined room: ${data.data.roomCode}`);
                        document.getElementById('roomStatus').textContent = `Joined room: ${data.data.roomCode}`;
                    } else if (data.type === 'chat_message') {
                        log(`💬 CHAT RECEIVED: [${data.data.playerName}] ${data.data.message}`);
                        document.getElementById('chatStatus').textContent = 'Chat message received!';
                    } else if (data.type === 'error') {
                        log(`❌ Server error: ${data.message}`);
                        document.getElementById('chatStatus').textContent = `Error: ${data.message}`;
                    }
                } catch (e) {
                    log(`❌ Failed to parse server message: ${e.message}`);
                }
            };
            
            ws.onclose = function() {
                log('❌ WebSocket disconnected');
                document.getElementById('wsStatus').textContent = 'Disconnected';
                connected = false;
            };
            
            ws.onerror = function(error) {
                log(`❌ WebSocket error: ${error}`);
                document.getElementById('wsStatus').textContent = 'Error';
            };
        }
        
        function createRoom() {
            if (!connected) {
                log('❌ WebSocket not connected');
                return;
            }
            
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                log('❌ Player name required');
                return;
            }
            
            const message = {
                type: 'create_room',
                data: {
                    playerName: playerName,
                    isPrivate: false
                },
                timestamp: Date.now()
            };
            
            log(`🏠 Creating NEW room as player: ${playerName}`);
            log(`📤 Sending: ${JSON.stringify(message)}`);
            
            ws.send(JSON.stringify(message));
            document.getElementById('roomStatus').textContent = 'Creating room...';
        }
        
        function joinRoom() {
            if (!connected) {
                log('❌ WebSocket not connected');
                return;
            }
            
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                log('❌ Player name required');
                return;
            }
            
            const message = {
                type: 'join_room',
                data: {
                    roomCode: '8LWJZZ',
                    playerName: playerName
                },
                timestamp: Date.now()
            };
            
            log(`🏠 Attempting to join room 8LWJZZ as player: ${playerName}`);
            log(`📤 Sending: ${JSON.stringify(message)}`);
            
            ws.send(JSON.stringify(message));
            document.getElementById('roomStatus').textContent = 'Joining room...';
        }
        
        function sendChatMessage() {
            if (!connected) {
                log('❌ WebSocket not connected');
                document.getElementById('chatStatus').textContent = 'Not connected';
                return;
            }
            
            if (!roomJoined) {
                log('❌ Not in a room - must join room first');
                document.getElementById('chatStatus').textContent = 'Not in room';
                return;
            }
            
            const messageText = document.getElementById('chatMessage').value.trim();
            if (!messageText) {
                log('❌ Message text required');
                return;
            }
            
            const message = {
                type: 'chat_message',
                data: {
                    message: messageText,
                    playerName: document.getElementById('playerName').value,
                    timestamp: Date.now()
                },
                timestamp: Date.now()
            };
            
            log(`💬 Sending chat message: "${messageText}"`);
            log(`📤 Raw message data: ${JSON.stringify(message)}`);
            
            try {
                ws.send(JSON.stringify(message));
                log('✅ Chat message sent to server');
                document.getElementById('chatMessage').value = '';
                document.getElementById('chatStatus').textContent = 'Message sent!';
            } catch (error) {
                log(`❌ Failed to send chat message: ${error.message}`);
                document.getElementById('chatStatus').textContent = 'Send failed';
            }
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        // Allow Enter key to send chat
        document.getElementById('chatMessage').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        // Auto-connect on page load
        window.onload = function() {
            testWebSocketConnection();
            
            // Auto-create room after connection
            setTimeout(() => {
                if (connected) {
                    createRoom();
                }
            }, 1000);
        };
    </script>
</body>
</html>
